<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagrama Causal - VENSIM Dashboard</title>
    <link rel="icon" href="{{ url_for('static', filename='ico/icono.ico') }}" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header class="app-header">
        <div class="header-content">
            <div class="header-brand">
                <div class="app-title">VENSIM TO PYTHON</div>
                <div class="app-subtitle">Dashboard dinámico de modelos de sistemas</div>
                <!-- Tech badges (from README) -->
                <div class="tech-badges" aria-hidden="true">
                    <img src="https://img.shields.io/badge/Python-3.9%2B-blue?style=flat&logo=python" alt="Python" />
                    <img src="https://img.shields.io/badge/Flask-2.0.2-green?style=flat&logo=flask" alt="Flask" />
                    <img src="https://img.shields.io/badge/PySD-3.14%2B-orange?style=flat" alt="PySD" />
                    <img src="https://img.shields.io/badge/License-MIT-yellow?style=flat" alt="License" />
                </div>
            </div>
            <nav class="app-nav">
                <a href="/diagrama-causal" class="nav-tab active" data-section="causal">
                    <i class="bi bi-diagram-3"></i>
                    <span>Diagrama causal</span>
                </a>
                <a href="/diagrama-forrester" class="nav-tab" data-section="forrester">
                    <i class="bi bi-share"></i>
                    <span>Diagrama de Forrester</span>
                </a>
                <a href="/" class="nav-tab" data-section="simulacion">
                    <i class="bi bi-bar-chart-line"></i>
                    <span>Tablas y simulación</span>
                </a>
                <a href="https://clinquant-dusk-5f3fd5.netlify.app/" class="nav-tab" target="_blank" rel="noopener noreferrer">
                    <i class="bi bi-water"></i>
                    <span>Símil Hidrodinámico</span>
                </a>
            </nav>
        </div>
    </header>

    <main class="app-main">
        <section class="content-section container-fluid">
            <div class="row justify-content-center">
                <div class="col-12 col-lg-10">
                    <article class="content-card">
                        <header class="content-header">
                            <div>
                                <h2 class="content-title">
                                    <i class="bi bi-diagram-3"></i>
                                    Diagrama Causal
                                </h2>
                                <p class="content-description">
                                    Representación visual de las relaciones causales entre las variables del sistema
                                </p>
                            </div>
                            {% if diagram %}
                            <div class="graph-controls">
                                <button class="graph-btn" title="Zoom In" onclick="zoomDiagram('in')">
                                    <i class="bi bi-zoom-in"></i>
                                </button>
                                <button class="graph-btn" title="Zoom Out" onclick="zoomDiagram('out')">
                                    <i class="bi bi-zoom-out"></i>
                                </button>
                                <button class="graph-btn" title="Resetear Vista" onclick="resetDiagram()">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </button>
                                <button class="graph-btn" title="Descargar PNG" onclick="downloadDiagram('Diagrama_Causal')">
                                    <i class="bi bi-download"></i>
                                </button>
                            </div>
                            {% endif %}
                        </header>
                        <div class="diagram-container" id="diagram-container">
                            {# Mostrar imagen fija del diagrama causal desde templates/ (archivo: diagrama causal.png) #}
                            {% if error %}
                                <div class="placeholder-content">
                                    <i class="bi bi-exclamation-triangle-fill placeholder-icon" style="color: #ef4444;"></i>
                                    <h3>Error al generar diagrama</h3>
                                    <p>{{ error }}</p>
                                </div>
                            {% else %}
                                <img id="diagram-image" src="{{ url_for('static', filename='images/diagrama causal.png') }}" alt="Diagrama de Lazos Causales" style="max-width: 100%; height: auto; border-radius: 0.5rem; cursor: grab; transition: transform 0.3s ease;">
                            {% endif %}
                        </div>
                    </article>
                </div>
            </div>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <script>
        let diagramScale = 1;
        let diagramTranslateX = 0;
        let diagramTranslateY = 0;
        let isDragging = false;
        let startX, startY;

        function zoomDiagram(direction) {
            const img = document.getElementById('diagram-image');
            if (!img) return;
            
            const zoomFactor = direction === 'in' ? 1.2 : 0.833;
            diagramScale *= zoomFactor;
            
            img.style.transform = `scale(${diagramScale}) translate(${diagramTranslateX}px, ${diagramTranslateY}px)`;
        }

        function resetDiagram() {
            const img = document.getElementById('diagram-image');
            if (!img) return;
            
            diagramScale = 1;
            diagramTranslateX = 0;
            diagramTranslateY = 0;
            
            img.style.transform = 'scale(1) translate(0px, 0px)';
        }

        function downloadDiagram(filename) {
            const img = document.getElementById('diagram-image');
            if (!img) return;
            
            const a = document.createElement('a');
            a.href = img.src;
            a.download = filename + '.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Habilitar arrastre
        window.addEventListener('load', function() {
            const img = document.getElementById('diagram-image');
            if (!img) return;
            
            img.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                img.style.cursor = 'grabbing';
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                diagramTranslateX += deltaX;
                diagramTranslateY += deltaY;
                
                img.style.transform = `scale(${diagramScale}) translate(${diagramTranslateX}px, ${diagramTranslateY}px)`;
                
                startX = e.clientX;
                startY = e.clientY;
            });
            
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    img.style.cursor = 'grab';
                }
            });
            
            // Zoom con rueda del ratón
            img.addEventListener('wheel', (e) => {
                e.preventDefault();
                const direction = e.deltaY < 0 ? 'in' : 'out';
                zoomDiagram(direction);
            });
        });
    </script>
</body>
</html>
